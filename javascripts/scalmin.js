Object.extend(Date.prototype,{monthnames:["January","February","March","April","May","June","July","August","September","October","November","December"],daynames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],set:function(_1){var _2=["Hours","Minutes","Seconds","Milliseconds"];for(var _3 in _1){try{if(_3=="Hours"&&Object.isArray(_1[_3])){_1[_3].each(function(p,i){this["set"+_2[i]](p);}.bind(this));}else{this["set"+_3](_1[_3]);}}catch(e){throw new SyntaxError("set"+_3+" is not a Date method");}}return this;},succ:function(){return new Date(this.getTime()).set({Date:this.getDate()+1});},firstofmonth:function(){return new Date(this.getFullYear(),this.getMonth(),1);},lastofmonth:function(){return new Date(this.getFullYear(),this.getMonth()+1,0);},formatPadding:true,format:function(f){if(!this.valueOf()){return "&nbsp;";}var d=this;var _8={"yyyy":d.getFullYear(),"mmmm":this.monthnames[d.getMonth()],"mmm":this.monthnames[d.getMonth()].substr(0,3),"mm":this.formatPadding?((d.getMonth()).succ()).toPaddedString(2):(d.getMonth()).succ(),"dddd":this.daynames[d.getDay()],"ddd":this.daynames[d.getDay()].substr(0,3),"dd":d.getDate().toPaddedString(2),"hh":h=d.getHours()%12?h:12,"nn":d.getMinutes(),"ss":d.getSeconds(),"a/p":d.getHours()<12?"a":"p"};return f.gsub(/(yyyy|mmmm|mmm|mm|dddd|ddd|dd|hh|nn|ss|a\/p)/i,function(_9){return _8[_9[0].toLowerCase()];});}});var scal={};scal=Class.create();scal.prototype={initialize:function(_a,_b){this.element=$(_a);var _c=Try.these(function(){if(!Object.isUndefined(Effect)){return "Effect";}},function(){return "Element";});this.options=Object.extend({aftercalchange:Prototype.emptyFunction,beforecalchange:Prototype.K,daypadding:false,titleformat:"mmmm yyyy",updateformat:"yyyy-mm-dd",closebutton:"X",prevbutton:"&laquo;",nextbutton:"&raquo;",yearnext:"&raquo;&raquo;",yearprev:"&laquo;&laquo;",openeffect:_c=="Effect"?Effect.Appear:Element.show,closeeffect:_c=="Effect"?Effect.Fade:Element.hide,exactweeks:false,dayheadlength:2,weekdaystart:0,planner:false,tabular:false},arguments[2]||{});this.table=false;this.thead=false;this.selectedElement=false;if(this.options.planner){this.planner=this._setupPlanner(this.options.planner);}if(this.options.tabular){this.table=new Element("table",{"class":"cal_table",border:0,cellspacing:0,cellpadding:0});this.thead=new Element("thead");this.table.insert(this.thead);this.element.insert(this.table);}this.updateelement=_b;this._setCurrentDate(this._setStartDate());this.startdate=new Date(this.currentdate);if(Object.isString(this.options.weekdaystart)){this.options.weekdaystart=this.currentdate.daynames.indexOf(this.options.weekdaystart)||0;}this.controls=this._buildControls();this.title.setAttribute("title",this.startdate.format(this.options.titleformat));this._updateTitles();this[this.table?"thead":"element"].insert(this.controls);this.cal_wrapper=this._buildHead();this.cells=[];this._buildSkel();},_setStartDate:function(){var _d=new Date();var _e=_d.getDate();var _f=this.options.month&&Object.isNumber(this.options.month)?this.options.month-1:_d.getMonth();var _10=this.options.year&&Object.isNumber(this.options.year)?this.options.year:_d.getFullYear();var day=this.options.day&&Object.isNumber(this.options.day)?this.options.day:(_f!=_d.getMonth())?1:_e;if(day!=_e){this.selectedDay=new Date(_10,_f,day,0,0,0,0);}return _d.set({Hours:[0,0,0,0],Date:day,Month:_f,FullYear:_10});},_click:function(_12,_13){if(this.selectedElement){this.selectedElement.removeClassName("dayselected");}this.selectedElement=(_12.target.hasClassName("daybox")?_12.target:_12.target.up()).addClassName("dayselected");this._setCurrentDate(this.dateRange[_13]);if(this.selectedDay){this.selectedDay.setTime(this.currentdate.getTime());}else{this.selectedDay=new Date(this.currentdate.getTime());}this._updateExternal();},_updateExternal:function(){if(Object.isFunction(this.updateelement)){this.updateelement(this.currentdate);}else{var _14=$(this.updateelement);_14[_14.tagName=="INPUT"?"setValue":"update"](this.currentdate.format(this.options.updateformat));}},_buildHead:function(){var _15=new Element(this.table?"tbody":"div",{"class":"cal_wrapper"});var _16=new Element(this.table?"tr":"div",{"class":"weekbox weekboxname"});Date.prototype.daynames.sortBy(function(s,i){i-=this.options.weekdaystart;return i<0?i+7:i;}.bind(this)).each(function(day,i){var _1b=new Element(this.table?"td":"div",{"class":"cal_day_name_"+i});_16.insert(_1b.addClassName("daybox").addClassName("dayboxname").update(day.substr(0,this.options.dayheadlength)));if(i==6){_1b.addClassName("endweek");}}.bind(this));return _15.insert(_16);},_buildWrapper:function(){var _1c=this.firstofmonth;var _1d=this.lastofmonth;var _1e=_1c.getDay();var _1f=_1c.getDate();if(this.options.exactweeks){while(_1d.getDay()<6){_1d=_1d.succ();}}_1e=(this.options.weekdaystart-_1e)<_1f?_1e+this.options.weekdaystart:(_1e+7)-this.options.weekdaystart;_1c.setDate(_1f-_1e);var _20=_1d.getTime();var _21=this.currentdate.getMonth();var _22=new Date();var _23={today:_22.getMonth()==_21?_22.setHours(0,0,0,0):false,dayselected:this.selectedDay&&(this.selectedDay.getMonth()==_21)?this.selectedDay.getTime():false};this.maxIndicators=["today","dayselected"].findAll(function(p){return _23[p]!==false;}).size();this.dateRange=[];this.indicators=[];this.cells.each(function(_25,_26){var day=(_25.weeknumber===0)&&(_26===0)?_1c:this.dateRange[_26-1].succ();this.cellClasses=["daybox",_25.cid,"daybox"+day.daynames[day.getDay()].toLowerCase()];this.dateRange[_26]=day;_25.d.innerHTML=this.options.daypadding?((day.getDate()).toPaddedString(2)):day.getDate();if(this.maxIndicators>0){this._compareDates(day,_23);}if(_25.daynumber==6){this.cellClasses.push("endweek");}this.cellClasses.push(day.getMonth()!=_21?"dayoutmonth":"dayinmonth");if(this.options.exactweeks){var _28=day.getTime()>_20?"hide":"show";if(this.table){_25.descendants().invoke(_28);}else{_25[_28]();}}if(this.options.planner){this._updatePlanner(day,_25.v);}_25.className=this.cellClasses.join(" ");}.bind(this));},_compareDates:function(_29,_2a){if(this.indicators.length==this.maxIndicators){return;}var _2b=_29.setHours(0,0,0,0);for(var _2c in _2a){if(!_2a[_2c]){continue;}if(this.indicators.indexOf(_2c)<0){if(_2b==_2a[_2c]){this.cellClasses.push(_2c);this.indicators.push(_2c);}}}},_buildSkel:function(){if(this.cells.size()===0){this.cal_weeks_wrapper=this.table?this.cal_wrapper:new Element("div",{"class":"calweekswrapper"});var _2d="cal_day_#{week}_#{day}";var _2e=0;$R(0,5).each(function(wk,_30){var row=new Element(this.table?"tr":"div",{"class":"cal_week_"+_30}).addClassName("weekbox");$R(0,6).each(function(dy,_33){var _34=_2d.interpolate({week:wk,day:dy});var _35=new Element(this.table?"td":"div",{"class":"daybox"});var _36=new Element("div",{"class":_34+"_date"}).addClassName("dayboxdate");var _37=new Element("div",{"class":_34+"_value"}).addClassName("dayboxvalue");Object.extend(_35,{cid:_34,weeknumber:_30,daynumber:_33,d:_36,v:_37});this.cells[_2e]=_35.observe("click",this._click.bindAsEventListener(this,_2e));row.insert(_35.insert(_36).insert(_37));_2e+=1;}.bind(this));this.cal_weeks_wrapper.insert(row);}.bind(this));if(this.table){this.table.insert(this.cal_wrapper);}else{this.element.insert(this.cal_wrapper).insert(this.cal_weeks_wrapper);}}this._buildWrapper();},_updateTitles:function(){var yr=this.currentdate.getFullYear();var _39=this.currentdate.getMonth();this.controls.select(".calcontrol").each(function(_3a){_3a.className.gsub(/cal(prev|next)(month|year)/,function(_3b){var _3c=false;if(_3b[1]=="prev"){_3c=_3b[2]=="year"?yr-1:Date.prototype.monthnames[(_39-1)==-1?11:_39-1];}else{if(_3b[1]=="next"){_3c=_3b[2]=="year"?yr+1:Date.prototype.monthnames[(_39+1)==12?0:_39+1];}}if(_3c){_3a.setAttribute("title",_3c);}});});},_buildControls:function(){var _3d=[{p:"calclose",u:this.options.closebutton,f:this.toggleCalendar.bindAsEventListener(this)},{p:"calprevmonth",u:this.options.prevbutton,f:this._switchCal.bindAsEventListener(this,"monthdown")},{p:"calprevyear",u:this.options.yearprev,f:this._switchCal.bindAsEventListener(this,"yeardown")},{p:"calnextyear",u:this.options.yearnext,f:this._switchCal.bindAsEventListener(this,"yearup")},{p:"calnextmonth",u:this.options.nextbutton,f:this._switchCal.bindAsEventListener(this,"monthup")},{p:"caltitle",u:this.currentdate.format(this.options.titleformat),f:this._switchCal.bindAsEventListener(this,"init")}];if(this.table){_3d=[_3d[1],_3d[2],_3d[5],_3d[3],_3d[4],_3d[0]];}var _3e=new Element(this.table?"tr":"div",{"class":"calheader"});_3d.each(function(_3f){var el=new Element(this.table?"td":"div",{"class":_3f.p});if(_3f.p=="caltitle"){this.title=el;if(this.table){el.writeAttribute({colspan:2});}el.update(_3f.u).observe("click",_3f.f);}else{el.addClassName("calcontrol");el[typeof (_3f.u)=="object"?"insert":"update"](_3f.u).observe("click",_3f.f);}_3e.insert(el);}.bind(this));return _3e;},_switchCal:function(){var _41=arguments[1]?arguments[1]:arguments[0];var _42={f:"setTime",p:this.startdate.getTime()};if(_41!="init"){var d=this.currentdate[_41.include("month")?"getMonth":"getFullYear"]();_42={f:_41.include("month")?"setMonth":"setYear",p:_41.include("up")?d+1:d-1};}if(arguments[1]){var _44=new Date(this.currentdate.getTime());_44[_42.f](_42.p);if(!this.options.beforecalchange(_44)){return;}}this.currentdate[_42.f](_42.p);if(arguments[1]){var _45=arguments[0];_45.date=this.currentdate;this.options.aftercalchange(_45);}this._update();},_update:function(){this._setCurrentDate(arguments[0]?arguments[0]:this.currentdate);this.title.innerHTML=this.currentdate.format(this.options.titleformat);this._buildWrapper();this._updateTitles();},_setCurrentDate:function(_46){this.currentdate=new Date(_46.getFullYear(),_46.getMonth(),_46.getDate());this.firstofmonth=this.currentdate.firstofmonth();this.lastofmonth=this.currentdate.lastofmonth();},_getCellIndexByDate:function(d){var dj=d.toJSON();var _49=0;this.dateRange.each(function(dt,i){if(dt.toJSON()==dj){_49=i;throw $break;}});return _49;},destroy:function(){this.cells.invoke("stopObserving").invoke("remove");this[this.table?"table":"cal_weeks_wrapper"].remove();this.controls.descendants().invoke("stopObserving");[this.cal_wrapper,this.controls].invoke("remove");this.element.descendants().invoke("remove");},setCurrentDate:function(_4c){this[(_4c instanceof Date)?"_update":"_switchCal"](_4c);if(!arguments[1]){this._updateExternal();}return this.currentdate;},toggleCalendar:function(){this.options[this.element.visible()?"closeeffect":"openeffect"](this.element);},getElementByDate:function(d){return this.cells[this._getCellIndexByDate(d)];},getElementsByWeek:function(_4e){return this.element.select(".weekbox:nth-of-type("+(_4e+1)+") .daybox:not(.dayboxname)");},getSelectedElement:function(){return this.element.select(".dayselected")[0];},getTodaysElement:function(){return this.element.select(".today")[0];},getDateByElement:function(_4f){return this.dateRange[this.cells.indexOf(_4f)];},_setupPlanner:Prototype.emptyFunction,_updatePlanner:Prototype.emptyFunction,openCalendar:function(){if(!this.isOpen()){this.toggleCalendar();}},closeCalendar:function(){if(this.isOpen()){this.toggleCalendar();}},isOpen:function(){return this.element.visible();}};